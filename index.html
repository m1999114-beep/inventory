<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>å·¥ç¨‹ç‰©æ–™æˆ°æƒ…å®¤ v10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { darkBg: '#0f172a', darkCard: '#1e293b' } }
            }
        }
    </script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #0f172a; color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glow-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid rgba(148, 163, 184, 0.1); }
        .category-btn.active { background-color: rgba(37, 99, 235, 0.2); border-color: #3b82f6; color: #fff; }
        .nav-btn.active { color: #3b82f6; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="pb-32 pt-6 px-4 min-h-screen">

    <div class="max-w-md mx-auto space-y-5">
        
        <div class="flex justify-between items-center pb-2">
            <div>
                <h1 class="text-2xl font-black text-white tracking-wider italic">WAR ROOM <span class="text-purple-400 text-sm not-italic font-normal px-2 py-0.5 rounded bg-purple-900/30">v10.1</span></h1>
                <p class="text-slate-400 text-xs mt-1">å…¬å¸/ç¾å ´é›™å‘ç›¤é»ç‰ˆ</p>
            </div>
            <div id="miniLog" class="hidden bg-slate-800 border border-slate-700 rounded-full px-3 py-1 flex items-center gap-2 text-xs text-slate-300">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span id="miniLogText" class="truncate max-w-[120px]">-</span>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-center">
                <p class="text-2xl">ğŸ“¦</p>
                <p class="text-xl font-bold text-white mt-1" id="statTotal">0</p>
                <p class="text-[10px] text-slate-500">ç¸½å“é …</p>
            </div>
            <div class="bg-slate-800 p-3 rounded-xl border border-red-900/50 text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-red-500/5 animate-pulse"></div>
                <p class="text-2xl">ğŸš¨</p>
                <p class="text-xl font-bold text-red-400 mt-1" id="statLow">0</p>
                <p class="text-[10px] text-red-400">ç¼ºè²¨å‘Šæ€¥</p>
            </div>
            <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 text-center">
                <p class="text-2xl">ğŸ“Š</p>
                <p class="text-xl font-bold text-blue-400 mt-1" id="statQty">0</p>
                <p class="text-[10px] text-slate-500">ç¸½åº«å­˜é‡</p>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-2">
            <button onclick="filterByCategory('wire')" id="btn-wire" class="category-btn flex flex-col items-center justify-center p-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-400"><span class="text-xl mb-1">ğŸ”Œ</span><span class="text-xs font-bold">é›»ç·š</span></button>
            <button onclick="filterByCategory('terminal')" id="btn-terminal" class="category-btn flex flex-col items-center justify-center p-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-400"><span class="text-xl mb-1">ğŸ”©</span><span class="text-xs font-bold">ç«¯å­</span></button>
            <button onclick="filterByCategory('hardware')" id="btn-hardware" class="category-btn flex flex-col items-center justify-center p-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-400"><span class="text-xl mb-1">ğŸ› ï¸</span><span class="text-xs font-bold">äº”é‡‘</span></button>
            <button onclick="filterByCategory('misc')" id="btn-misc" class="category-btn flex flex-col items-center justify-center p-3 rounded-lg bg-slate-800 border border-slate-700 text-slate-400"><span class="text-xl mb-1">ğŸ©¹</span><span class="text-xs font-bold">è€—æ</span></button>
        </div>
        <button onclick="filterByCategory('all')" id="btn-all" class="w-full text-xs text-slate-500 py-2 hover:text-white transition bg-slate-800/50 rounded-lg">é¡¯ç¤ºå…¨éƒ¨é …ç›®</button>

        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-slate-500">ğŸ”</span></div>
            <input type="text" id="searchInput" oninput="filterData()" class="block w-full pl-10 pr-3 py-3 border border-slate-700 rounded-xl bg-slate-900 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-sm" placeholder="è¼¸å…¥é—œéµå­—...">
        </div>

        <div id="loading" class="text-center py-20"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div><p class="text-slate-500 text-sm">é€£ç·šä¸­...</p></div>
        <div id="inventoryList" class="space-y-3 pb-10"></div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-slate-800 pb-safe pt-2 px-6 z-40">
        <div class="flex justify-between items-center max-w-md mx-auto h-16">
            <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="nav-btn active flex flex-col items-center w-16 text-slate-500"><span class="text-xl mb-1">ğŸ </span><span class="text-[10px]">é¦–é </span></button>
            <button onclick="openSiteReport()" class="nav-btn flex flex-col items-center w-16 text-slate-500"><span class="text-xl mb-1">ğŸ­</span><span class="text-[10px]">å ±è¡¨</span></button>
            <div class="relative -top-5"><button onclick="openBatchModal()" class="w-14 h-14 bg-blue-600 rounded-full shadow-lg flex items-center justify-center text-white text-2xl border-4 border-slate-900 active:bg-blue-700">âš¡</button></div>
            <button onclick="loadData()" class="nav-btn flex flex-col items-center w-16 text-slate-500"><span class="text-xl mb-1">ğŸ”„</span><span class="text-[10px]">åˆ·æ–°</span></button>
            <button onclick="alert('ç´«è‰²æŒ‰éˆ•ï¼šç›¤é»å…¬å¸å€‰\nç¶ è‰²æŒ‰éˆ•ï¼šç›¤é»ç¾å ´å€‰')" class="nav-btn flex flex-col items-center w-16 text-slate-500"><span class="text-xl mb-1">â„¹ï¸</span><span class="text-[10px]">èªªæ˜</span></button>
        </div>
    </nav>

    <div id="modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-end md:items-center justify-center p-4">
        <div class="bg-slate-800 w-full md:max-w-sm rounded-2xl border border-slate-600 p-5">
            <div class="flex justify-between items-start mb-4">
                <div><h3 id="modalTitle" class="text-xl font-bold text-white">å‹•ä½œ</h3><p id="modalItem" class="text-slate-400 text-sm mt-1">å“å</p></div>
                <button onclick="closeModal()" class="text-slate-400 text-2xl px-2">Ã—</button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 text-xs">
                    <span class="bg-blue-900/50 text-blue-300 px-2 py-1 rounded" id="infoSite">Site: -</span>
                    <span class="bg-green-900/50 text-green-300 px-2 py-1 rounded" id="infoWarehouse">WH: -</span>
                </div>
                <select id="inputPerson" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white text-lg"><option value="åŒäº‹">åŒäº‹</option><option value="é»ƒå‡Œç‘‹">é»ƒå‡Œç‘‹</option><option value="å…¶ä»–">å…¶ä»–</option></select>
                <div class="relative"><input type="number" id="inputQty" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-4 text-3xl font-bold text-white text-center" placeholder="æ•¸é‡"><span class="absolute right-4 top-6 text-slate-500 text-sm" id="modalUnit">å–®ä½</span></div>
                <button id="confirmBtn" onclick="submitAction()" class="w-full py-4 rounded-lg font-bold text-white text-lg bg-blue-600">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <div id="batchModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-lg rounded-2xl border border-slate-600 flex flex-col h-[70vh]">
            <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-bold text-white">âš¡ æ‡¶äººè¨˜äº‹æœ¬</h3><button onclick="closeBatchModal()" class="text-slate-400 text-2xl">Ã—</button></div>
            <div class="flex-1 p-4 overflow-y-auto space-y-3">
                <div class="bg-slate-900/50 p-2 rounded border border-slate-700 text-xs text-slate-400"><p>ğŸ’¡ æç¤ºï¼šåœ°é» (f22) è«‹å–®ç¨ä¸€è¡Œ</p></div>
                <textarea id="batchInput" class="w-full h-40 bg-slate-900 border border-slate-600 rounded-lg p-3 text-white font-mono text-lg" placeholder="f22&#10;3awg 5"></textarea>
                <div id="previewList" class="space-y-2 pb-4"></div>
            </div>
            <div class="p-4 border-t border-slate-700 bg-slate-900 flex gap-2">
                <button onclick="parseBatchInput()" class="flex-1 py-3 bg-slate-700 rounded-lg text-white font-bold">è§£æ</button>
                <button id="batchConfirmBtn" onclick="submitBatch()" class="flex-[2] py-3 bg-blue-600 text-white rounded-lg font-bold disabled:bg-slate-700 disabled:text-slate-500" disabled>ç¢ºèªå¯«å…¥</button>
            </div>
        </div>
    </div>

    <div id="siteReportModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-600 flex flex-col max-h-[80vh]">
            <div class="bg-indigo-900/50 p-4 border-b border-indigo-500/20 flex justify-between items-center"><h3 class="text-lg font-bold text-white">ğŸ­ å» å€åº«å­˜</h3><button onclick="closeSiteReport()" class="text-slate-400 text-2xl">Ã—</button></div>
            <div class="flex-1 p-4 overflow-y-auto"><div id="siteListContainer" class="grid grid-cols-2 gap-3"></div><div id="siteDetailContainer" class="hidden space-y-3"><button onclick="backToSiteList()" class="text-sm text-slate-400 mb-2">â¬… è¿”å›</button><h4 id="siteDetailTitle" class="text-xl font-bold text-white mb-4"></h4><div id="siteDetailList" class="space-y-2"></div></div></div>
        </div>
    </div>

    <script>
        // è¨­å®šå€
        const API_URL = "https://script.google.com/macros/s/AKfycby2nSnqLZyeTPKARgOnYdrGQ-8_FZJEzkF8VeN6Ypwcq5xDLTCbddhsOsU5eB2qM0-bKg/exec"; 

        let currentData = [], displayData = [], batchUpdates = [], siteData = {}, selectedItem = null, selectedAction = '';

        window.onload = loadData;

        async function loadData() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            document.getElementById('inventoryList').innerHTML = '';
            
            try {
                const res = await fetch(API_URL);
                const response = await res.json();
                currentData = response.stock.map(item => ({
                    id: item.id, name: item.name, spec: item.spec, unit: item.unit,
                    warehouseQty: Number(item.warehouseQty) || 0,
                    siteQty: Number(item.siteQty) || 0,
                    safeQty: Number(item.safeQty) || 0,
                    alias: item.alias || ''
                }));
                siteData = response.sites || {};
                
                loading.classList.add('hidden');
                updateStats(currentData);
                if(response.lastLog) {
                    const minilog = document.getElementById('miniLog');
                    minilog.classList.remove('hidden');
                    document.getElementById('miniLogText').innerText = `${response.lastLog.person}: ${response.lastLog.name}`;
                }
                filterByCategory('all');
            } catch (err) {
                loading.innerHTML = `<div class='text-red-400'>é€£ç·šå¤±æ•—</div>`;
                console.error(err);
            }
        }

        function updateStats(data) {
            document.getElementById('statTotal').innerText = data.length;
            document.getElementById('statLow').innerText = data.filter(i => i.siteQty < i.safeQty && i.safeQty > 0).length;
            document.getElementById('statQty').innerText = data.reduce((acc, c) => acc + c.siteQty, 0).toFixed(0);
        }

        function filterByCategory(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            if(category !== 'all') document.getElementById(`btn-${category}`).classList.add('active');
            displayData = category === 'all' ? currentData : currentData.filter(item => {
                const name = (item.name + item.spec).toLowerCase();
                if (category === 'wire') return name.includes('ç·š') || name.includes('çºœ');
                if (category === 'terminal') return name.includes('ç«¯å­');
                if (category === 'hardware') return name.includes('ç®¡') || name.includes('æ¥é ­') || name.includes('ç›’') || name.includes('ç‰™åœˆ');
                if (category === 'misc') return name.includes('è† å¸¶') || name.includes('å¥—ç®¡') || name.includes('ç´®ç·š') || name.includes('æŸå¸¶');
                return false;
            });
            renderList(displayData);
        }

        function filterData() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            renderList(displayData.filter(item => (item.name + item.spec + item.alias).toLowerCase().includes(keyword)));
        }

        function getIcon(name) {
            if(name.includes('ç·š') || name.includes('çºœ')) return 'ğŸ”Œ';
            if(name.includes('ç«¯å­')) return 'ğŸ”©';
            if(name.includes('ç®¡') || name.includes('æ¥é ­') || name.includes('ç›’')) return 'ğŸ› ï¸';
            return 'ğŸ“¦';
        }

        function renderList(data) {
            const list = document.getElementById('inventoryList');
            list.innerHTML = '';
            if (data.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 py-10">ç„¡é …ç›®</div>'; return; }
            
            data.forEach(item => {
                const isLow = item.siteQty < item.safeQty && item.safeQty > 0;
                const borderClass = isLow ? 'border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]' : 'border-slate-700';
                const bgClass = isLow ? 'bg-gradient-to-r from-slate-800 to-red-900/20' : 'bg-slate-800';
                const icon = getIcon(item.name);

                list.innerHTML += `
                    <div class="glow-card relative p-4 rounded-xl border ${borderClass} ${bgClass} flex justify-between items-center gap-3">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-lg bg-slate-700/50 flex items-center justify-center text-xl">${icon}</div>
                            <div class="min-w-0">
                                <h3 class="font-bold text-white text-base truncate">${item.name}</h3>
                                <p class="text-xs text-slate-400 truncate">${item.spec}</p>
                                ${isLow ? '<span class="text-[10px] text-red-400 font-bold">âš ï¸ åº«å­˜ä¸è¶³</span>' : ''}
                            </div>
                        </div>
                        <div class="text-right min-w-[50px]">
                            <div class="text-2xl font-black ${isLow ? 'text-red-400' : 'text-blue-400'}">${item.siteQty}</div>
                            <div class="text-[10px] text-slate-500">${item.unit}</div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="openModal('${item.id}', 'move_to_site')" class="bg-blue-600 text-white w-10 h-8 rounded flex items-center justify-center font-bold shadow active:scale-95">ğŸšš</button>
                            <button onclick="openModal('${item.id}', 'audit')" class="bg-green-600 text-white w-10 h-8 rounded flex items-center justify-center font-bold shadow active:scale-95">ğŸ“</button>
                            <button onclick="openModal('${item.id}', 'warehouse_audit')" class="bg-purple-600 text-white w-10 h-8 rounded flex items-center justify-center font-bold shadow active:scale-95">ğŸ¢</button>
                        </div>
                    </div>`;
            });
        }

        // Modal Functions
        function openModal(id, action) {
            selectedItem = currentData.find(i => i.id == id);
            selectedAction = action;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('inputQty').value = '';
            document.getElementById('modalItem').innerText = `${selectedItem.name} ${selectedItem.spec}`;
            document.getElementById('modalUnit').innerText = selectedItem.unit;
            document.getElementById('infoSite').innerText = `ç¾å ´: ${selectedItem.siteQty}`;
            document.getElementById('infoWarehouse').innerText = `å€‰åº«: ${selectedItem.warehouseQty}`;
            
            const btn = document.getElementById('confirmBtn');
            const title = document.getElementById('modalTitle');
            
            if(action === 'move_to_site') {
                title.innerText = "ğŸšš å¸¶æ–™å…¥å» ";
                btn.className = "w-full py-4 rounded-lg font-bold text-white text-lg bg-blue-600 active:bg-blue-700";
                btn.innerText = "ç¢ºèªå¸¶å…¥ (+)";
            } else if(action === 'audit') {
                title.innerText = "ğŸ“ ç¾å ´ç›¤é»";
                document.getElementById('inputQty').value = selectedItem.siteQty;
                btn.className = "w-full py-4 rounded-lg font-bold text-white text-lg bg-green-600 active:bg-green-700";
                btn.innerText = "ä¿®æ­£ç¾å ´ (=)";
            } else if(action === 'warehouse_audit') {
                title.innerText = "ğŸ¢ å…¬å¸å€‰ç›¤é»";
                document.getElementById('inputQty').value = selectedItem.warehouseQty;
                btn.className = "w-full py-4 rounded-lg font-bold text-white text-lg bg-purple-600 active:bg-purple-700";
                btn.innerText = "ä¿®æ­£å…¬å¸ (=)";
            }
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        async function submitAction() {
            const qty = Number(document.getElementById('inputQty').value);
            const person = document.getElementById('inputPerson').value;
            const btn = document.getElementById('confirmBtn');
            if(qty < 0) return alert("æ•¸é‡éŒ¯èª¤");
            btn.innerText = "è™•ç†ä¸­...";
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: selectedAction, id: selectedItem.id, qty, person }) });
            closeModal();
            loadData();
        }

        // æ‡¶äººåŠŸèƒ½
        function openBatchModal() { document.getElementById('batchModal').classList.remove('hidden'); document.getElementById('previewList').innerHTML = ''; document.getElementById('batchInput').value = ''; document.getElementById('batchConfirmBtn').disabled = true; document.getElementById('batchConfirmBtn').classList.add('bg-slate-700'); }
        function closeBatchModal() { document.getElementById('batchModal').classList.add('hidden'); }
        function parseBatchInput() {
            const raw = document.getElementById('batchInput').value;
            const lines = raw.split('\n');
            const preview = document.getElementById('previewList');
            preview.innerHTML = ''; batchUpdates = []; let currentLoc = "æœªçŸ¥"; let validCount = 0;
            lines.forEach(line => {
                line = line.trim(); if(!line) return;
                const parts = line.split(/\s+/);
                if(parts.length === 1 && isNaN(parseFloat(parts[0]))) { currentLoc = parts[0]; preview.innerHTML += `<div class='text-purple-300 text-xs mt-3 font-bold border-b border-purple-500/30 pb-1'>ğŸ“ åˆ‡æ›è‡³å» å€ï¼š${currentLoc}</div>`; return; }
                const qty = parseFloat(parts.pop());
                const key = parts.join(' ').toLowerCase();
                if(isNaN(qty)) { preview.innerHTML += `<div class='bg-red-900/40 p-2 rounded text-xs text-red-300 mt-1'>âŒ æ ¼å¼éŒ¯èª¤: ${line}</div>`; return; }
                const target = currentData.find(i => (i.alias && i.alias.toLowerCase().includes(key)) || i.name.toLowerCase().includes(key));
                if(target) {
                    batchUpdates.push({id: target.id, qty, location: currentLoc});
                    validCount++;
                    preview.innerHTML += `<div class='flex justify-between bg-slate-700/50 p-2 rounded text-xs border-l-4 border-green-500 mt-1'><div><span class='text-white font-bold'>${target.name}</span></div><span class='text-green-400 font-bold'>${qty}</span></div>`;
                } else {
                    preview.innerHTML += `<div class='flex justify-between bg-red-900/20 p-2 rounded text-xs border border-red-900/50 mt-1'><span class='text-red-400 font-bold'>â“ æœªçŸ¥ä»£ç¢¼: "${key}"</span></div>`;
                }
            });
            const btn = document.getElementById('batchConfirmBtn');
            if(validCount > 0) { btn.disabled = false; btn.classList.remove('bg-slate-700'); btn.classList.add('bg-blue-600'); btn.innerText = `å¯«å…¥ ${validCount} ç­†è³‡æ–™`; }
        }
        async function submitBatch() {
            document.getElementById('batchConfirmBtn').innerText = "å¯«å…¥ä¸­...";
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "batch_audit", updates: batchUpdates, person: "æ‡¶äººè¼¸å…¥" }) });
            closeBatchModal();
            loadData();
        }

        // å ±è¡¨åŠŸèƒ½
        function openSiteReport() {
            document.getElementById('siteReportModal').classList.remove('hidden');
            document.getElementById('siteListContainer').classList.remove('hidden');
            document.getElementById('siteDetailContainer').classList.add('hidden');
            const container = document.getElementById('siteListContainer');
            container.innerHTML = '';
            Object.keys(siteData).forEach(site => {
                const count = Object.keys(siteData[site].items).length;
                container.innerHTML += `<button onclick="showSiteDetail('${site}')" class="bg-slate-700 p-4 rounded-xl text-left border border-slate-600"><div class="text-2xl mb-1">ğŸ“</div><div class="font-bold text-white text-lg">${site}</div><div class="text-xs text-slate-400">${count} é …</div></button>`;
            });
        }
        function closeSiteReport() { document.getElementById('siteReportModal').classList.add('hidden'); }
        function showSiteDetail(site) {
            document.getElementById('siteListContainer').classList.add('hidden');
            document.getElementById('siteDetailContainer').classList.remove('hidden');
            document.getElementById('siteDetailTitle').innerText = site;
            const list = document.getElementById('siteDetailList');
            list.innerHTML = '';
            Object.values(siteData[site].items).forEach(i => {
                list.innerHTML += `<div class="bg-slate-900 p-3 rounded-lg flex justify-between border border-slate-700"><div><div class="text-white font-bold">${i.name}</div><div class="text-xs text-slate-500">${i.spec}</div></div><div class="text-xl font-bold text-indigo-400">${i.qty}</div></div>`;
            });
        }
        function backToSiteList() { document.getElementById('siteListContainer').classList.remove('hidden'); document.getElementById('siteDetailContainer').classList.add('hidden'); }
    </script>
</body>
</html>
